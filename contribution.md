# Contribution

## Introduction

The purpose of this library is facilitating the use of [DSP-API (Knora)](https://www.knora.org) in web client development. 
It offers a convenient way to communicate with the DSP-API without knowing specific technical details.  

## Development

### Prerequisites

For development, you need to install [`yalc`](<https://www.npmjs.com/package/yalc>) globally. 
Run `npm install yalc -g`. This will enable you to build and publish DSP-JS-LIB locally.

### Dependencies

This library depends on `RxJS`, `jsonld`, and `json2typescript`.
`jsonld` and `json2typescript` are only used internally and listed as dependencies in `package.json`.

`RxJS` is listed as a peer dependency and **not** installed with `npm install`.
It can be installed running `npm run peer-deps` **after** `npm install`.

`RxJS`'s `Observable` is used in this library's public API
and has to be compatible with whatever version of `RxJS` is used in the productive environment, e.g. an Angular application.
This library works with `RxJS`'s major version defined in `package.json` . See `rxjs.md` for details.

### Scripts for testing and development

This package provides the following short-hand scripts:

1. `npm run peer-deps`: Installs the project's peer dependencies. Peer dependencies are not installed with `npm install`, but have to be met before building or running the tests.
1. `npm run test`: Runs the library's tests defined in `./karma.conf.js`.
1. `npm run prepare-dev-publication`: prepares a dev version of the library **before** building it. The dev version contains code to create mocked data to be used in unit test of projects using DSP-JS-LIB.
1. `npm run build`: Builds the whole library without testing and puts the files into the `./build/` folder.
1. `npm run yalc-publish`: Builds and publishes the package to the yalc app store (local publication of the lib).
1. `npm run npm-pack`: Tests and builds the library and then and packs the `./build/` folder into an NPM tgz package. The package is moved into a `./dist/` folder.

### Dev Version

The dev versions contains mocks that produce tests data without a connection to DSP-API.
These mocks were originally developed for internal use, but can be used to get data for unit test in projects that use DSP-JS-LIB.
The following example shows how to get a mocked resource without a connection to DSP-API:

```ts
import { MockResource } from "@dasch-swiss/dsp-js";

MockResource.getTestThing().subscribe(
    (testthing: ReadResource) => {
        console.log(testthing);
    }
)
```

The mocks are configured in `scripts/mock-exports.json`.

If you need a local version of this library that contains the mocks, do the following:
   - `npm run prepare-dev-publication` to prepare a dev version.
   - `npm run yalc-publish` to publish a local build containing the mocks.
   
**Note that `prepare-dev-publication` modifies `package.json`, `tsconfig.json` and `index.ts`. Do not commit these changes.**

### Integrating Generated Test Data from DSP-API

To integrate tests date generated by DSP-API, the following scripts can be used:

1. `npm run integrate-admin-test-data <path-to-generated-client-code>`: integrates generated test data for the DSP-API Admin part,
see <https://docs.knora.org> -> Internals -> Development -> Generating Client Test Data.
1. `npm run integrate-v2-test-data <path-to-generated-client-code>`: integrates JSON-LD test data for Knora API v2,
see <https://docs.knora.org> -> Internals -> Development -> Generating Client Test Data.
The test data files have to be added to `scripts/v2-test-data-config.json`: `source` refers to their location in the DSP-API test data directory structure,
`destination` refers to their location in this repo. The test data files are copied when running the script.
1. `npm run expand-jsonld-test-data`: creates versions with expanded prefixes for DSP-API v2 JSON-LD test data.
1. `npm run prepare-dev-publication`: prepares a dev version of the library for publication.

By default, all generated test data for the admin API is integrated with the script `npm run integrate-admin-test-data`.

Test data for v2 has to be added to `scripts/v2-test-data-config.json` to be used in the unit tests.
All files that are contained in `scripts/v2-test-data-config.json` will be copied this library's tests data when running `npm run integrate-v2-test-data`.

Example:

```json
{
  "generated-test-data": [
    {
      "source": "/v2/ontologies/all-ontology-metadata-response.json",
      "destination": "./test/data/api/v2/ontologies/all-ontology-metadata-response.json"
    },
    ...
  ]
}
```

The example shown above will copy the file `/v2/ontologies/all-ontology-metadata-response.json`
from the generated test data to the specified destination in this library's test data folder.
In the unit tests, this file can then be used to mock request and response data.

When adding a new method to a v2 endpoint, only add the test data needed to test this method to facilitate the review process.
**Do not add v2 test data that is not used in the unit tests.**

After integrating v2 test data, run `npm run expand-jsonld-test-data`.


### Change Supported Version of DSP-API

DSP-JS is compatible with a specified release of DSP-API.
To update the target release of DSP-API, the following steps have to be carried out:

1. Update DSP-API version in
   - `vars.mk`, e.g., change `v13.0.0-rc.16` to `v13.0.0-rc.17`.
   - `src/api/system/health/health-endpoint.spec.ts`
1. Delete local test data with `make delete-test-data`
1. Generate test data using the target DSP-API release,
   - Variant 1: See <https://docs.knora.org> -> Internals -> Development -> Generating Client Test Data
   and copy generated test data from DSP-API repository to DSP-JS-Lib repo:
   Run from project root: `cp /Folder/To/Knora-Api/client-test-data.zip ./`
   - Variant 2: Download test-data from DSP-API release with `make get-test-data-from-release`
1. Unpack generated test data and integrate it with `make prepare-test-data`
1. Run the unit tests with `npm test` from the project root.
1. Check for differences in the generated test data with respect to the previous release of DSP-API.
   If there are changes in the test data that have **no breaking effect**, integrate them (add them to the git repo).
   Otherwise, DSP-JS has to be adapted to comply with the later version of DSP-JS. Also see section "Integration of Generated Test Data".
1. Run the e2e tests against the target release of DSP-API:
   - prepare the local publication of the library using `npm run prepare-dev-publication`
   - build the library and publish it locally with `npm run yalc-publish`
   - change to directory `test-framework`
   - add the locally build library using `npm run yalc-add` and run `npm install`
   - run `npm run webdriver-update` and then `npm run e2e`
1. See if the tests pass on GitHub CI

### Test Environment

`./test-framework` provides a ready-to-use test environment for Angular developers. See `./test-framework/README.md` for further instructions.

## Testing

Component have their own spec files defining unit tests.
Since this library relies on DSP-API,
static test data is generated from DSP-API and integrated automatically.

Actual calls to the DSP-API in production are mocked with `jasmine.Ajax`.
The data is read from the static test data files and passed to `jasmine.Ajax`,
so the component under test can react to it.

If a component A depends on a component B, then B has to be mocked during the test using a `jasmine.Spy`.
The behavior of component B is simulated and a fake response is returned.
Mocking components turned out to be quite complex for the `OntologyCache`. 
Therefore, the mock has been made a stand-alone testing component called `MockOntology` that can be reused.
It can also be used to generate static test data in software projects using this library.

Since `MockOntology` is complex, some global assertions are made to guarantee that the mock behaves as the actual component.
These assertions are defined in `MockOntologyAssertions`.
